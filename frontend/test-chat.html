<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat Test</title>
    <style>
        .chat-container {
            width: 600px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
        }
        #messageArea {
            height: 300px;
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 10px;
            overflow-y: auto;
        }
        .login-container {
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f0f0;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="login-container">
            <input type="number" id="userId" placeholder="Enter User ID">
            <input type="number" id="locationId" placeholder="Enter Location ID">
            <button onclick="joinChat()">Join Chat</button>
        </div>

        <div id="chatArea" style="display: none;">
            <h3>Chat Room: <span id="roomInfo"></span></h3>
            <div id="messageArea"></div>
            <input type="text" id="messageInput" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let ws;
        let currentUserId;
        let currentLocationId;

        function joinChat() {
            currentUserId = document.getElementById('userId').value;
            currentLocationId = document.getElementById('locationId').value;

            if (!currentUserId || !currentLocationId) {
                alert('Please enter both User ID and Location ID');
                return;
            }

            // Connect to WebSocket with location ID
            ws = new WebSocket(`ws://localhost:9095/ws/chat?locationId=${currentLocationId}`);

            ws.onopen = () => {
                console.log('Connected to chat');
                document.getElementById('chatArea').style.display = 'block';
                document.getElementById('roomInfo').textContent = `Location ${currentLocationId}`;
                
                // Load chat history
                loadChatHistory();
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                displayMessage(message);
            };

            ws.onclose = () => {
                console.log('Disconnected from chat');
            };
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value;

            if (!content) return;

            const message = {
                senderId: parseInt(currentUserId),
                locationId: parseInt(currentLocationId),
                content: content
            };

            ws.send(JSON.stringify(message));
            messageInput.value = '';
        }

        function loadChatHistory() {
            fetch(`http://localhost:9095/api/messages/${currentLocationId}`)
                .then(response => response.json())
                .then(messages => {
                    messages.forEach(displayMessage);
                })
                .catch(error => console.error('Error loading chat history:', error));
        }

        function displayMessage(message) {
            const messageArea = document.getElementById('messageArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.textContent = `User ${message.senderId}: ${message.content}`;
            messageArea.appendChild(messageDiv);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        // Handle Enter key in message input
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>